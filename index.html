<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì–´ ë„ì¥ ìƒì„±ê¸° (ì¸í„°ë™í‹°ë¸Œ í¸ì§‘)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Google Fonts ì„í¬íŠ¸ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Sunflower:wght@300;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f7f7f7;
            user-select: none; /* ìº”ë²„ìŠ¤ ë“œë˜ê·¸ ì‹œ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
        }
        
        #canvasContainer {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .color-input {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 6px;
        }

        /* ìº”ë²„ìŠ¤ ì»¤ì„œ ìŠ¤íƒ€ì¼ */
        #stampCanvas.grabbing {
            cursor: grabbing;
        }
        #stampCanvas.grab {
            cursor: grab;
        }
        #stampCanvas.resizing {
            cursor: nwse-resize; /* ê¸°ë³¸ ë¦¬ì‚¬ì´ì¦ˆ ì»¤ì„œ */
        }
        #stampCanvas.tl, #stampCanvas.br {
            cursor: nwse-resize;
        }
        #stampCanvas.tr, #stampCanvas.bl {
            cursor: nesw-resize;
        }
        #stampCanvas.tm, #stampCanvas.bm {
            cursor: ns-resize;
        }
        #stampCanvas.ml, #stampCanvas.mr {
            cursor: ew-resize;
        }
    </style>
    <script>
        const CANVAS_SIZE = 250; 
        
        const FONT_OPTIONS = [
            { name: "Noto Sans KR (ë³¸ê³ ë”•)", value: "'Noto Sans KR', sans-serif" },
            { name: "Nanum Myeongjo (ë‚˜ëˆ”ëª…ì¡°)", value: "'Nanum Myeongjo', serif" },
            { name: "Gowun Batang (ê³ ìš´ë°”íƒ•)", value: "'Gowun Batang', serif" },
            { name: "Sunflower (í•´ë°”ë¼ê¸°)", value: "'Sunflower', sans-serif" },
            { name: "ì‹œìŠ¤í…œ ê¸°ë³¸ (ì‚°ì„¸ë¦¬í”„)", value: "sans-serif" },
            { name: "ì‹œìŠ¤í…œ ê¸°ë³¸ (ëª…ì¡°)", value: "serif" }
        ];

        const SHAPE_OPTIONS = [
            { name: "ì›í˜• (Circle)", value: "circle" },
            { name: "ì •ì‚¬ê°í˜• (Square)", value: "square" }
        ];

        let stampConfig = {
            name: 'ì œë¯¸ë‹ˆ',
            font: FONT_OPTIONS[0].value,
            shape: 'circle', 
            stampColor: '#C0392B',
            bgColor: '#ffffff',
            letters: [] // {char: 'A', x: 0, y: 0, fontSize: 60, selected: false, width: 0, height: 0, handles: []}
        };

        let selectedLetterIndex = -1; // í˜„ì¬ ì„ íƒëœ ê¸€ìì˜ ì¸ë±ìŠ¤
        let isDragging = false;       // ë“œë˜ê·¸ ì¤‘ì¸ì§€ ì—¬ë¶€
        let isResizing = false;       // í¬ê¸° ì¡°ì ˆ ì¤‘ì¸ì§€ ì—¬ë¶€
        let resizeHandleType = null;  // 'tl', 'tr', 'bl', 'br', 'tm', etc.

        let dragStartX = 0;           // ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ì‹œì‘ ì‹œ ë§ˆìš°ìŠ¤ X
        let dragStartY = 0;           // ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ì‹œì‘ ì‹œ ë§ˆìš°ìŠ¤ Y
        let letterOffsetX = 0;        // ê¸€ì ê¸°ì¤€ ë§ˆìš°ìŠ¤ X ì˜¤í”„ì…‹
        let letterOffsetY = 0;        // ê¸€ì ê¸°ì¤€ ë§ˆìš°ìŠ¤ Y ì˜¤í”„ì…‹

        // ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸
        let canvas, ctx;

        /**
         * ë„ì¥ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ëŠ” ë©”ì¸ í•¨ìˆ˜
         */
        function drawStamp() {
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (ë°°ê²½ìƒ‰ ì ìš©)
            ctx.fillStyle = stampConfig.bgColor;
            ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            
            const borderWidth = 8;
            const centerX = CANVAS_SIZE / 2;
            const centerY = CANVAS_SIZE / 2;

            // 1. í…Œë‘ë¦¬ ê·¸ë¦¬ê¸°
            ctx.strokeStyle = stampConfig.stampColor;
            ctx.lineWidth = borderWidth;
            ctx.beginPath();
            
            if (stampConfig.shape === 'circle') {
                const radius = (CANVAS_SIZE - borderWidth) / 2;
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
            } else if (stampConfig.shape === 'square') {
                const innerSize = CANVAS_SIZE - borderWidth;
                ctx.rect(borderWidth / 2, borderWidth / 2, innerSize, innerSize);
            }
            ctx.stroke();

            // 2. ê¸€ì ê·¸ë¦¬ê¸°
            ctx.fillStyle = stampConfig.stampColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            stampConfig.letters.forEach((letter, index) => {
                ctx.font = `900 ${letter.fontSize}px ${stampConfig.font}`; 
                ctx.fillText(letter.char, letter.x, letter.y);

                // ì„ íƒëœ ê¸€ìì— í…Œë‘ë¦¬ ë° í•¸ë“¤ í‘œì‹œ
                if (index === selectedLetterIndex) {
                    const padding = 10;
                    const handleSize = 10;
                    const halfHandle = handleSize / 2;
                    
                    // í…ìŠ¤íŠ¸ í¬ê¸° ì¸¡ì •
                    ctx.font = `900 ${letter.fontSize}px ${stampConfig.font}`; // í°íŠ¸ ì„¤ì • ë‹¤ì‹œ ì ìš©
                    const textMetrics = ctx.measureText(letter.char);
                    const textWidth = textMetrics.width;
                    const textHeight = letter.fontSize * 0.9; // í°íŠ¸ í¬ê¸°ë¥¼ ë†’ì´ë¡œ ê°€ì • (ì•½ê°„ ì¡°ì •)

                    // Bounding Box ì¢Œí‘œ ê³„ì‚° (ì¤‘ì•™ ì •ë ¬ ê¸°ì¤€)
                    const rectX = letter.x - textWidth / 2;
                    const rectY = letter.y - textHeight / 2;
                    const rectW = textWidth;
                    const rectH = textHeight;

                    // Bounding Box ê·¸ë¦¬ê¸°
                    ctx.strokeStyle = '#3b82f6'; // íŒŒë€ìƒ‰
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]); // ì ì„ 
                    ctx.strokeRect(rectX - padding, rectY - padding, rectW + 2 * padding, rectH + 2 * padding);
                    ctx.setLineDash([]); // ì ì„  í•´ì œ
                    
                    // 8ê°œì˜ í•¸ë“¤ ìœ„ì¹˜ ê³„ì‚°
                    const corners = [
                        { x: rectX - padding, y: rectY - padding, type: 'tl' }, // Top-Left
                        { x: rectX + rectW / 2, y: rectY - padding, type: 'tm' }, // Top-Mid
                        { x: rectX + rectW + padding, y: rectY - padding, type: 'tr' }, // Top-Right
                        { x: rectX + rectW + padding, y: rectY + rectH / 2, type: 'mr' }, // Mid-Right
                        { x: rectX + rectW + padding, y: rectY + rectH + padding, type: 'br' }, // Bottom-Right
                        { x: rectX + rectW / 2, y: rectY + rectH + padding, type: 'bm' }, // Bottom-Mid
                        { x: rectX - padding, y: rectY + rectH + padding, type: 'bl' }, // Bottom-Left
                        { x: rectX - padding, y: rectY + rectH / 2, type: 'ml' }, // Mid-Left
                    ];

                    // í•¸ë“¤ ê·¸ë¦¬ê¸°
                    ctx.fillStyle = '#3b82f6';
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    corners.forEach(corner => {
                        ctx.fillRect(corner.x - halfHandle, corner.y - halfHandle, handleSize, handleSize);
                        ctx.strokeRect(corner.x - halfHandle, corner.y - halfHandle, handleSize, handleSize);
                    });
                    
                    // í•¸ë“¤ ì •ë³´ë¥¼ ê¸€ìì— ì €ì¥ (íˆíŠ¸ ê°ì§€ìš©)
                    letter.handles = corners;
                    letter.textWidth = textWidth;
                    letter.textHeight = textHeight;
                    letter.padding = padding;
                }
            });
        }

        /**
         * ê¸€ì ìˆ˜ì— ë”°ë¼ ê¸°ë³¸ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ ê³„ì‚°í•˜ê³  stampConfig.lettersë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateConfigAndRedraw(newName, newFont, newShape, newStampColor, newBgColor) {
            const trimmedName = (newName || stampConfig.name).replace(/\s/g, '');
            const length = trimmedName.length;
            const downloadButton = document.getElementById('downloadButton'); // ë²„íŠ¼ ì°¸ì¡°

            const messageBox = document.getElementById('messageBox');
            if (length < 2 || length > 4) {
                messageBox.textContent = 'ì´ë¦„ì€ 2ìì—ì„œ 4ì ì‚¬ì´ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
                messageBox.classList.remove('hidden');
                if (ctx) ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                renderLetterEditor();
                downloadButton.disabled = true; // ê¸€ìê°€ ì—†ìœ¼ë©´ ë‹¤ìš´ë¡œë“œ ë¹„í™œì„±í™”
                return;
            }
            messageBox.classList.add('hidden');

            const nameChanged = trimmedName !== stampConfig.letters.map(l => l.char).join('') || stampConfig.letters.length !== length;
            
            stampConfig.name = trimmedName;
            if (newFont) stampConfig.font = newFont;
            if (newShape) stampConfig.shape = newShape;
            if (newStampColor) stampConfig.stampColor = newStampColor;
            if (newBgColor) stampConfig.bgColor = newBgColor;

            if (nameChanged) {
                stampConfig.letters = [];
                const centerX = CANVAS_SIZE / 2;
                const centerY = CANVAS_SIZE / 2;
                let defaultFontSize = 0;

                if (length === 2) {
                    defaultFontSize = 80;
                    stampConfig.letters.push({ char: trimmedName[0], x: centerX, y: centerY - 45, fontSize: defaultFontSize });
                    stampConfig.letters.push({ char: trimmedName[1], x: centerX, y: centerY + 45, fontSize: defaultFontSize });
                } else if (length === 3) {
                    defaultFontSize = 65;
                    stampConfig.letters.push({ char: trimmedName[0], x: centerX, y: centerY - 60, fontSize: defaultFontSize });
                    stampConfig.letters.push({ char: trimmedName[1], x: centerX, y: centerY, fontSize: defaultFontSize });
                    stampConfig.letters.push({ char: trimmedName[2], x: centerX, y: centerY + 60, fontSize: defaultFontSize });
                } else if (length === 4) {
                    defaultFontSize = 60;
                    const offset = 45; 
                    stampConfig.letters.push({ char: trimmedName[0], x: centerX - offset, y: centerY - offset, fontSize: defaultFontSize });
                    stampConfig.letters.push({ char: trimmedName[1], x: centerX - offset, y: centerY + offset, fontSize: defaultFontSize });
                    stampConfig.letters.push({ char: trimmedName[2], x: centerX + offset, y: centerY - offset, fontSize: defaultFontSize });
                    stampConfig.letters.push({ char: trimmedName[3], x: centerX + offset, y: centerY + offset, fontSize: defaultFontSize });
                }
                
                selectedLetterIndex = -1;
                renderLetterEditor();
            }

            drawStamp();
            downloadButton.disabled = false; // ë„ì¥ì´ ìƒì„±ë˜ë©´ ë‹¤ìš´ë¡œë“œ í™œì„±í™”
        }

        /**
         * ê¸€ì ìœ„ì¹˜ ë° í¬ê¸° í¸ì§‘ê¸°ë¥¼ ë™ì ìœ¼ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderLetterEditor() {
            const editorDiv = document.getElementById('letterEditor');
            let html = '';
            
            if (stampConfig.letters.length === 0) {
                editorDiv.innerHTML = '<p class="text-gray-500 text-center">ì´ë¦„ì„ ì…ë ¥í•˜ì—¬ ê¸€ì í¸ì§‘ê¸°ë¥¼ í™œì„±í™”í•˜ì„¸ìš”.</p>';
                document.getElementById('letterEditorContainer').classList.remove('hidden');
                return;
            }

            stampConfig.letters.forEach((letter, index) => {
                const isSelectedClass = index === selectedLetterIndex ? 'border-red-500 bg-red-50' : 'border-gray-200 bg-white';
                html += `
                    <div class="flex items-center space-x-3 p-3 ${isSelectedClass} rounded-lg shadow-sm transition-all duration-100">
                        <span class="font-bold text-red-600 w-8 text-center text-xl">${letter.char}</span>
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-gray-500">X (ê°€ë¡œ)</label>
                            <input type="number" data-index="${index}" data-coord="x" value="${Math.round(letter.x)}" min="0" max="${CANVAS_SIZE}"
                                class="w-full px-2 py-1 border rounded-md text-sm focus:ring-red-500" oninput="handleCoordChange(this)">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-gray-500">Y (ì„¸ë¡œ)</label>
                            <input type="number" data-index="${index}" data-coord="y" value="${Math.round(letter.y)}" min="0" max="${CANVAS_SIZE}"
                                class="w-full px-2 py-1 border rounded-md text-sm focus:ring-red-500" oninput="handleCoordChange(this)">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-gray-500">í¬ê¸°</label>
                            <input type="number" data-index="${index}" data-coord="fontSize" value="${Math.round(letter.fontSize)}" min="10" max="150"
                                class="w-full px-2 py-1 border rounded-md text-sm focus:ring-red-500" oninput="handleCoordChange(this)">
                        </div>
                    </div>
                `;
            });
            editorDiv.innerHTML = html;
            document.getElementById('letterEditorContainer').classList.remove('hidden');
        }

        /**
         * ê¸€ì ì¢Œí‘œ/í¬ê¸° ì…ë ¥ê°’ ë³€ê²½ í•¸ë“¤ëŸ¬
         */
        function handleCoordChange(input) {
            const index = parseInt(input.dataset.index);
            const coord = input.dataset.coord;
            const value = parseFloat(input.value);

            if (isNaN(value) || value < 0) {
                console.warn(`Invalid value: ${value}`);
                return; 
            }
            
            if (coord === 'fontSize') {
                // í°íŠ¸ í¬ê¸° ë²”ìœ„ ì œí•œ (10 ~ 150)
                stampConfig.letters[index][coord] = Math.max(10, Math.min(150, value));
            } else {
                // X, Y ì¢Œí‘œ ë²”ìœ„ ì œí•œ (0 ~ CANVAS_SIZE)
                stampConfig.letters[index][coord] = Math.max(0, Math.min(CANVAS_SIZE, value));
            }
            
            drawStamp();
        }

        /**
         * ëª¨ë“  ê¸€ìì˜ í¬ê¸°ë¥¼ ì¼ê´„ì ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
         */
        function handleBatchSizeChange() {
            const input = document.getElementById('batchSizeInput');
            const newSize = parseFloat(input.value);
            const messageBox = document.getElementById('messageBox');

            if (stampConfig.letters.length === 0) {
                messageBox.textContent = 'ë¨¼ì € ì´ë¦„ì„ ì…ë ¥í•˜ì—¬ ë„ì¥ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.';
                messageBox.classList.remove('hidden');
                return;
            }

            if (isNaN(newSize) || newSize < 10 || newSize > 150) {
                messageBox.textContent = 'ì¼ê´„ í¬ê¸°ëŠ” 10ì—ì„œ 150 ì‚¬ì´ì˜ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
                messageBox.classList.remove('hidden');
                return;
            }
            messageBox.classList.add('hidden');

            stampConfig.letters.forEach(letter => {
                letter.fontSize = newSize;
            });

            // í¸ì§‘ê¸° ë° ìº”ë²„ìŠ¤ ì—…ë°ì´íŠ¸
            renderLetterEditor();
            drawStamp();
        }
        
        // ... (handleConfigChange, generateStamp, downloadStamp í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€) ...
        function handleConfigChange(type, value) {
            if (type === 'stampColor') stampConfig.stampColor = value;
            else if (type === 'bgColor') stampConfig.bgColor = value;
            else if (type === 'shape') stampConfig.shape = value;
            else if (type === 'font') stampConfig.font = value;
            
            drawStamp();
        }

        function generateStamp() {
            const name = document.getElementById('nameInput').value;
            const selectedFont = document.getElementById('fontSelect').value;
            const selectedShape = document.getElementById('shapeSelect').value;
            const stampColor = document.getElementById('stampColorInput').value;
            const bgColor = document.getElementById('bgColorInput').value;

            const currentName = stampConfig.letters.map(l => l.char).join('');
            
            if (name.replace(/\s/g, '') !== currentName || stampConfig.letters.length === 0) {
                updateConfigAndRedraw(name, selectedFont, selectedShape, stampColor, bgColor);
            } else {
                updateConfigAndRedraw(null, selectedFont, selectedShape, stampColor, bgColor);
            }
             // ì´ë¦„ ë³€ê²½ì´ ì—†ì–´ë„ ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
            if (stampConfig.letters.length >= 2 && stampConfig.letters.length <= 4) {
                 document.getElementById('downloadButton').disabled = false;
            }
        }

        function downloadStamp() {
            const name = document.getElementById('nameInput').value.replace(/\s/g, '');
            const filename = `ë„ì¥_${name || 'ìƒˆì´ë¦„'}.png`;

            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png'); 
            link.click();
        }

        // --- ìº”ë²„ìŠ¤ ì¸í„°ë™ì…˜ ë¡œì§ ---

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX = e.clientX;
            let clientY = e.clientY;

            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        /**
         * í•¸ë“¤ì„ í´ë¦­í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
         */
        function checkHandleHit(mousePos) {
            const letter = stampConfig.letters[selectedLetterIndex];
            if (!letter || !letter.handles) return null;

            const handleSize = 10;
            const halfHandle = handleSize / 2;

            for (const handle of letter.handles) {
                if (mousePos.x >= handle.x - halfHandle && mousePos.x <= handle.x + halfHandle &&
                    mousePos.y >= handle.y - halfHandle && mousePos.y <= handle.y + halfHandle) {
                    return handle.type; // 'tl', 'tr', 'br', etc. ë°˜í™˜
                }
            }
            return null;
        }

        /**
         * ê¸€ì ìì²´ë¥¼ í´ë¦­í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
         */
        function checkLetterHit(mousePos) {
            for (let i = 0; i < stampConfig.letters.length; i++) {
                const letter = stampConfig.letters[i];
                ctx.font = `900 ${letter.fontSize}px ${stampConfig.font}`;
                const textMetrics = ctx.measureText(letter.char);
                const textWidth = textMetrics.width;
                const textHeight = letter.fontSize;

                const hitBuffer = 15;
                const x1 = letter.x - textWidth / 2 - hitBuffer;
                const y1 = letter.y - textHeight / 2 - hitBuffer;
                const x2 = letter.x + textWidth / 2 + hitBuffer;
                const y2 = letter.y + textHeight / 2 + hitBuffer;

                if (mousePos.x >= x1 && mousePos.x <= x2 &&
                    mousePos.y >= y1 && mousePos.y <= y2) {
                    return i;
                }
            }
            return -1;
        }

        function setCanvasCursor(handleType) {
            canvas.classList.remove('grab', 'tl', 'tr', 'br', 'bl', 'tm', 'bm', 'ml', 'mr', 'grabbing');
            if (handleType) {
                canvas.classList.add(handleType);
            }
        }
        
        window.onload = function() {
            canvas = document.getElementById('stampCanvas');
            ctx = canvas.getContext('2d');
            canvas.width = CANVAS_SIZE;
            canvas.height = CANVAS_SIZE;

            // ... (ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™” ë° UI ê°’ ì ìš© ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€) ...
            const fontSelect = document.getElementById('fontSelect');
            FONT_OPTIONS.forEach(font => {
                const option = document.createElement('option');
                option.value = font.value;
                option.textContent = font.name;
                fontSelect.appendChild(option);
            });
            
            const shapeSelect = document.getElementById('shapeSelect');
            SHAPE_OPTIONS.forEach(shape => {
                const option = document.createElement('option');
                option.value = shape.value;
                option.textContent = shape.name;
                shapeSelect.appendChild(option);
            });
            
            document.getElementById('nameInput').value = stampConfig.name;
            document.getElementById('stampColorInput').value = stampConfig.stampColor;
            document.getElementById('bgColorInput').value = stampConfig.bgColor;
            document.getElementById('fontSelect').value = stampConfig.font;
            document.getElementById('shapeSelect').value = stampConfig.shape;

            updateConfigAndRedraw(stampConfig.name, stampConfig.font, stampConfig.shape, stampConfig.stampColor, stampConfig.bgColor);
            renderLetterEditor();

            document.getElementById('nameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    generateStamp();
                }
            });

            // --- ìº”ë²„ìŠ¤ ì¸í„°ë™ì…˜ ë¡œì§ ---
            
            const handleDown = (e) => {
                e.preventDefault();
                const mousePos = getMousePos(e);
                let hitIndex = -1;
                let handleType = null;

                // 1. ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ íˆíŠ¸ ê°ì§€ (ì„ íƒëœ ê¸€ìê°€ ìˆì–´ì•¼ í•¨)
                if (selectedLetterIndex !== -1) {
                    handleType = checkHandleHit(mousePos);
                    if (handleType) {
                        isResizing = true;
                        resizeHandleType = handleType;
                        dragStartX = mousePos.x;
                        dragStartY = mousePos.y;
                        canvas.classList.add('grabbing');
                        return;
                    }
                }
                
                // 2. ê¸€ì ìì²´ íˆíŠ¸ ê°ì§€ (ë“œë˜ê·¸)
                hitIndex = checkLetterHit(mousePos);
                if (hitIndex !== -1) {
                    selectedLetterIndex = hitIndex;
                    isDragging = true;
                    
                    letterOffsetX = mousePos.x - stampConfig.letters[selectedLetterIndex].x;
                    letterOffsetY = mousePos.y - stampConfig.letters[selectedLetterIndex].y;

                    canvas.classList.add('grabbing');
                } else {
                    // 3. ì•„ë¬´ê²ƒë„ í´ë¦­í•˜ì§€ ì•Šì•˜ì„ ë•Œ ì„ íƒ í•´ì œ
                    selectedLetterIndex = -1;
                    canvas.classList.remove('grabbing');
                    setCanvasCursor(null);
                }
                renderLetterEditor();
                drawStamp();
            };

            const handleMove = (e) => {
                e.preventDefault(); 
                const mousePos = getMousePos(e);
                const letter = stampConfig.letters[selectedLetterIndex];
                
                if (isResizing && selectedLetterIndex !== -1) {
                    // --- ë¦¬ì‚¬ì´ì§• ë¡œì§ ---
                    const deltaX = mousePos.x - dragStartX;
                    const deltaY = mousePos.y - dragStartY;
                    
                    // í¬ê¸° ë³€í™” ê³„ì‚°. Uniform Scalingì„ ìœ„í•´ X, Y ë³€í™” ì¤‘ ë” í° ê°’ì„ ì‚¬ìš©
                    let sizeDelta = 0;

                    // ì½”ë„ˆ í•¸ë“¤: ëŒ€ê°ì„  ë°©í–¥ ì´ë™ì— ë”°ë¼ í¬ê¸° ì¡°ì ˆ
                    if (resizeHandleType.includes('t') && resizeHandleType.includes('l')) { // tl
                        sizeDelta = -(deltaX + deltaY) * 0.5;
                    } else if (resizeHandleType.includes('t') && resizeHandleType.includes('r')) { // tr
                        sizeDelta = (deltaX - deltaY) * 0.5;
                    } else if (resizeHandleType.includes('b') && resizeHandleType.includes('l')) { // bl
                        sizeDelta = (-deltaX + deltaY) * 0.5;
                    } else if (resizeHandleType.includes('b') && resizeHandleType.includes('r')) { // br
                        sizeDelta = (deltaX + deltaY) * 0.5;
                    } 
                    // ì¸¡ë©´ í•¸ë“¤ì€ ì½”ë„ˆ í•¸ë“¤ê³¼ ìœ ì‚¬í•˜ê²Œ ì²˜ë¦¬í•˜ì—¬ ìœ ë‹ˆí¼ ìŠ¤ì¼€ì¼ë§ ìœ ì§€
                    else if (resizeHandleType === 'tm' || resizeHandleType === 'bm') {
                         sizeDelta = resizeHandleType === 'tm' ? -deltaY * 0.8 : deltaY * 0.8;
                    } else if (resizeHandleType === 'ml' || resizeHandleType === 'mr') {
                         sizeDelta = resizeHandleType === 'ml' ? -deltaX * 0.8 : deltaX * 0.8;
                    }

                    // ìƒˆ í°íŠ¸ í¬ê¸° ê³„ì‚° ë° ì œí•œ (10px ~ 150px)
                    let newFontSize = letter.fontSize + sizeDelta * 0.2; // Scaling sensitivity 0.2
                    newFontSize = Math.max(10, Math.min(150, newFontSize));
                    
                    if (letter.fontSize !== newFontSize) {
                        letter.fontSize = newFontSize;

                        // ìˆ«ì ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
                        const sizeInput = document.querySelector(`input[data-index="${selectedLetterIndex}"][data-coord="fontSize"]`);
                        if (sizeInput) sizeInput.value = Math.round(newFontSize);
                    }

                    // ë“œë˜ê·¸ ì‹œì‘ì  ì—…ë°ì´íŠ¸ (ìƒëŒ€ì ì¸ ì›€ì§ì„ì„ ìœ„í•´)
                    dragStartX = mousePos.x;
                    dragStartY = mousePos.y;
                    
                } else if (isDragging && selectedLetterIndex !== -1) {
                    // --- ë“œë˜ê·¸ ë¡œì§ ---
                    letter.x = mousePos.x - letterOffsetX;
                    letter.y = mousePos.y - letterOffsetY;

                    letter.x = Math.max(0, Math.min(CANVAS_SIZE, letter.x));
                    letter.y = Math.max(0, Math.min(CANVAS_SIZE, letter.y));

                    const xInput = document.querySelector(`input[data-index="${selectedLetterIndex}"][data-coord="x"]`);
                    const yInput = document.querySelector(`input[data-index="${selectedLetterIndex}"][data-coord="y"]`);
                    if (xInput && yInput) {
                        xInput.value = Math.round(letter.x);
                        yInput.value = Math.round(letter.y);
                    }
                } else {
                    // ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ì´ ì•„ë‹ˆë©´ ì»¤ì„œ ì—…ë°ì´íŠ¸
                    if (selectedLetterIndex !== -1) {
                        const handleType = checkHandleHit(mousePos);
                        if (handleType) {
                            setCanvasCursor(handleType);
                        } else if (checkLetterHit(mousePos) !== -1) {
                            setCanvasCursor('grab');
                        } else {
                            setCanvasCursor(null);
                        }
                    } else {
                        setCanvasCursor(null);
                    }
                }
                
                drawStamp();
            };

            const handleUp = () => {
                isDragging = false;
                isResizing = false;
                resizeHandleType = null;
                canvas.classList.remove('grabbing');
                drawStamp();
            };
            
            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            canvas.addEventListener('mousedown', handleDown);
            canvas.addEventListener('mousemove', handleMove);
            canvas.addEventListener('mouseup', handleUp);
            
            // í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            canvas.addEventListener('touchstart', handleDown);
            canvas.addEventListener('touchmove', handleMove);
            canvas.addEventListener('touchend', handleUp);

            // Esc í‚¤ë¡œ ì„ íƒ í•´ì œ
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && selectedLetterIndex !== -1) {
                    selectedLetterIndex = -1;
                    renderLetterEditor();
                    drawStamp();
                }
            });
        };
    </script>
</head>
<body class="p-4 sm:p-8 flex items-start justify-center min-h-screen">
    <div class="bg-white p-6 sm:p-10 rounded-xl shadow-2xl w-full max-w-5xl flex flex-col lg:flex-row space-y-8 lg:space-y-0 lg:space-x-8">
        
        <!-- ì„¤ì • ë° í¸ì§‘ê¸° íŒ¨ë„ --><div class="lg:w-1/2 flex flex-col space-y-6">
            <h1 class="text-3xl font-extrabold text-gray-800 text-center lg:text-left">
                ğŸ‡°ğŸ‡· ë„ì¥ ì„¤ì • í¸ì§‘ê¸°
            </h1>
            <p class="text-gray-600">ì´ë¦„ì„ ì…ë ¥í•˜ê³ , ì›í•˜ëŠ” í°íŠ¸, í˜•íƒœ, ìƒ‰ìƒì„ ì„ íƒí•œ í›„ ê¸€ì ë°°ì¹˜ë¥¼ ì¡°ì •í•˜ì—¬ ì™„ë²½í•œ ë„ì¥ì„ ë§Œë“œì„¸ìš”. **ìº”ë²„ìŠ¤ì—ì„œ ê¸€ìë¥¼ ì§ì ‘ ë“œë˜ê·¸ ë° í¬ê¸° ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!**</p>

            <!-- í•„ìˆ˜ ì„¤ì • (ì´ë¦„ ì…ë ¥ ë° ìƒì„±) --><div class="p-4 bg-gray-50 rounded-xl shadow-inner space-y-3">
                <label for="nameInput" class="block font-bold text-gray-700">ì´ë¦„ ì…ë ¥ (2~4ì)</label>
                <input 
                    type="text" 
                    id="nameInput" 
                    maxlength="4"
                    placeholder="ì—¬ê¸°ì— ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í™ê¸¸ë™)" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-lg font-semibold"
                >
                <button 
                    onclick="generateStamp()" 
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-200 text-lg active:scale-95 transform"
                >
                    ë„ì¥ ë¯¸ë¦¬ë³´ê¸°
                </button>
            </div>
            
            <!-- ê¸°ë³¸ ì˜µì…˜ (í°íŠ¸, í˜•íƒœ, ìƒ‰ìƒ) --><div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- í°íŠ¸ ì„ íƒ --><div>
                    <label for="fontSelect" class="block font-bold text-gray-700 mb-1">í°íŠ¸ ì„ íƒ</label>
                    <select 
                        id="fontSelect" 
                        class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 bg-white"
                        onchange="handleConfigChange('font', this.value)"
                    >
                        <!-- ì˜µì…˜ì€ JavaScriptì—ì„œ ì±„ì›Œì§‘ë‹ˆë‹¤. --></select>
                </div>

                <!-- í˜•íƒœ ì„ íƒ --><div>
                    <label for="shapeSelect" class="block font-bold text-gray-700 mb-1">ë„ì¥ í˜•íƒœ</label>
                    <select 
                        id="shapeSelect" 
                        class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 bg-white"
                        onchange="handleConfigChange('shape', this.value)"
                    >
                        <!-- ì˜µì…˜ì€ JavaScriptì—ì„œ ì±„ì›Œì§‘ë‹ˆë‹¤. --></select>
                </div>

                <!-- ìƒ‰ìƒ ì„ íƒ --><div class="flex space-x-2">
                    <div>
                        <label for="stampColorInput" class="block font-bold text-gray-700 mb-1">ì¸ì£¼ìƒ‰</label>
                        <input type="color" id="stampColorInput" class="color-input" onchange="handleConfigChange('stampColor', this.value)">
                    </div>
                    <div>
                        <label for="bgColorInput" class="block font-bold text-gray-700 mb-1">ë°°ê²½ìƒ‰</label>
                        <input type="color" id="bgColorInput" class="color-input" onchange="handleConfigChange('bgColor', this.value)">
                    </div>
                </div>
            </div>

            <!-- ì¼ê´„ í¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡¤ ì¶”ê°€ -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner space-y-3">
                <h3 class="text-xl font-bold text-gray-700">ê¸€ì ì¼ê´„ í¬ê¸° ì¡°ì • (10~150px)</h3>
                <div class="flex space-x-3">
                    <input 
                        type="number" 
                        id="batchSizeInput" 
                        placeholder="ìƒˆ í¬ê¸° ì…ë ¥ (10~150)" 
                        min="10" 
                        max="150"
                        class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-base"
                    >
                    <button 
                        onclick="handleBatchSizeChange()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 active:scale-95 transform"
                    >
                        ì¼ê´„ ì ìš©
                    </button>
                </div>
            </div>

            <!-- ê¸€ì ìœ„ì¹˜ í¸ì§‘ê¸° --><div id="letterEditorContainer" class="bg-gray-100 p-4 rounded-xl shadow">
                <h3 class="text-xl font-bold text-gray-800 mb-3">ê¸€ì ìœ„ì¹˜ ë° í¬ê¸° ë¯¸ì„¸ ì¡°ì •</h3>
                <div id="letterEditor" class="space-y-2">
                    <!-- ê¸€ìë³„ X/Y/í¬ê¸° ì…ë ¥ í•„ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤. --></div>
            </div>
        </div>


        <!-- ë„ì¥ ë¯¸ë¦¬ë³´ê¸° ë° ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ --><div class="lg:w-1/2 flex flex-col items-center space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">ë„ì¥ ë¯¸ë¦¬ë³´ê¸°</h2>
            
            <!-- ìº”ë²„ìŠ¤ ê²½ê³  ë©”ì‹œì§€ --><div id="messageBox" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-3 rounded-md w-full" role="alert">
                <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. --></div>

            <div id="canvasContainer" class="rounded-xl overflow-hidden border-2 border-gray-300">
                <canvas 
                    id="stampCanvas" 
                    width="250" 
                    height="250" 
                    class="block grab"
                ></canvas>
            </div>
            
            <button 
                id="downloadButton"
                onclick="downloadStamp()" 
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transform"
            >
                PNG ì´ë¯¸ì§€ë¡œ ë‹¤ìš´ë¡œë“œ
            </button>
        </div>
        
    </div>
</body>
</html>
